{
    "sourceFile": "lib/blocs/component/repository/component_repository.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1734043322906,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1734045072674,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,64 +1,106 @@\n // lib/blocs/component/repository/component_repository.dart\r\n \r\n+import 'package:cloud_firestore/cloud_firestore.dart';\r\n import '../../../modules/system_operation_also_main_module/models/system_component.dart';\r\n+import '../../../repositories/base_repository.dart';\r\n import '../../../services/auth_service.dart';\r\n-import '../../../repositories/system_state_repository.dart';\r\n+import '../../../utils/data_point_cache.dart';\r\n \r\n-class ComponentRepository {\r\n-  final SystemStateRepository _systemStateRepository;\r\n+class ComponentRepository extends BaseRepository<SystemComponent> {\r\n   final AuthService _authService;\r\n+  final DataPointCache _dataPointCache;\r\n \r\n-  ComponentRepository(this._systemStateRepository, this._authService);\r\n+  ComponentRepository(this._authService)\r\n+      : _dataPointCache = DataPointCache(),\r\n+        super('system_components');\r\n \r\n+  @override\r\n+  SystemComponent fromJson(Map<String, dynamic> json) =>\r\n+      SystemComponent.fromJson(json);\r\n+\r\n   Future<SystemComponent?> getComponent(String componentName) async {\r\n     final userId = _authService.currentUser?.uid;\r\n     if (userId == null) {\r\n       throw Exception('User not authenticated');\r\n     }\r\n-    return await _systemStateRepository.getComponentByName(userId, componentName);\r\n+    return await get(componentName, userId: userId);\r\n   }\r\n \r\n-  Future<void> saveComponent(SystemComponent component) async {\r\n+  Future<List<SystemComponent>> getAllComponents() async {\r\n     final userId = _authService.currentUser?.uid;\r\n     if (userId == null) {\r\n       throw Exception('User not authenticated');\r\n     }\r\n-    await _systemStateRepository.saveComponent(userId, component);\r\n+    return await getAll(userId: userId);\r\n   }\r\n \r\n-  Future<void> saveComponentState(SystemComponent component) async {\r\n+  Future<List<SystemComponent>> getActiveComponents() async {\r\n     final userId = _authService.currentUser?.uid;\r\n     if (userId == null) {\r\n       throw Exception('User not authenticated');\r\n     }\r\n-    await _systemStateRepository.saveComponentState(userId, component);\r\n+\r\n+    QuerySnapshot activeComponents = await getUserCollection(userId)\r\n+        .where('isActivated', isEqualTo: true)\r\n+        .get();\r\n+\r\n+    return activeComponents.docs\r\n+        .map((doc) => fromJson(doc.data() as Map<String, dynamic>))\r\n+        .toList();\r\n   }\r\n \r\n-  Future<List<Map<String, dynamic>>> getComponentHistory(\r\n+  Future<void> updateComponentState(\r\n     String componentName,\r\n-    DateTime start,\r\n-    DateTime end,\r\n+    Map<String, double> newState,\r\n   ) async {\r\n     final userId = _authService.currentUser?.uid;\r\n     if (userId == null) {\r\n       throw Exception('User not authenticated');\r\n     }\r\n-    return await _systemStateRepository.getComponentHistory(\r\n-      userId,\r\n-      componentName,\r\n-      start,\r\n-      end,\r\n-    );\r\n+\r\n+    await getUserCollection(userId)\r\n+        .doc(componentName)\r\n+        .update({'currentValues': newState});\r\n   }\r\n \r\n-  Stream<SystemComponent?> watchComponent(String componentName) async* {\r\n+  Stream<SystemComponent?> watchComponent(String componentName) {\r\n     final userId = _authService.currentUser?.uid;\r\n     if (userId == null) {\r\n       throw Exception('User not authenticated');\r\n     }\r\n \r\n-    // This is where you'd implement real-time watching using Firestore\r\n-    // For now, we'll just yield the current state\r\n-    yield await getComponent(componentName);\r\n+    return getUserCollection(userId)\r\n+        .doc(componentName)\r\n+        .snapshots()\r\n+        .map((doc) => doc.exists\r\n+            ? fromJson(doc.data() as Map<String, dynamic>)\r\n+            : null);\r\n   }\r\n+\r\n+  // DataPoint Cache methods\r\n+  void cacheDataPoint(\r\n+    String componentName,\r\n+    String parameter,\r\n+    DataPoint dataPoint, {\r\n+    int maxPoints = DataPointCache.DEFAULT_MAX_POINTS,\r\n+  }) {\r\n+    _dataPointCache.addDataPoint(\r\n+      componentName,\r\n+      parameter,\r\n+      dataPoint,\r\n+      maxPoints: maxPoints,\r\n+    );\r\n+  }\r\n+\r\n+  List<DataPoint> getCachedDataPoints(String componentName, String parameter) {\r\n+    return _dataPointCache.getDataPoints(componentName, parameter);\r\n+  }\r\n+\r\n+  DataPoint? getLatestDataPoint(String componentName, String parameter) {\r\n+    return _dataPointCache.getLatestDataPoint(componentName, parameter);\r\n+  }\r\n+\r\n+  void clearCache() {\r\n+    _dataPointCache.clearAll();\r\n+  }\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1734070480353,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -63,8 +63,19 @@\n         .doc(componentName)\r\n         .update({'currentValues': newState});\r\n   }\r\n \r\n+  Future<void> saveComponentState(SystemComponent component) async {\r\n+    final userId = _authService.currentUser?.uid;\r\n+    if (userId == null) {\r\n+      throw Exception('User not authenticated');\r\n+    }\r\n+\r\n+    await getUserCollection(userId)\r\n+        .doc(component.name)\r\n+        .set(component.toJson(), SetOptions(merge: true));\r\n+  }\r\n+\r\n   Stream<SystemComponent?> watchComponent(String componentName) {\r\n     final userId = _authService.currentUser?.uid;\r\n     if (userId == null) {\r\n       throw Exception('User not authenticated');\r\n"
                },
                {
                    "date": 1734070801058,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,9 @@\n // lib/blocs/component/repository/component_repository.dart\r\n \r\n import 'package:cloud_firestore/cloud_firestore.dart';\r\n-import 'package:experiment_planner/modules/system_operation_also_main_module/models/data_point.dart';\r\n+import '../../../modules/system_operation_also_main_module/models/data_point.dart';\r\n+// Update other imports to use relative paths\r\n import '../../../modules/system_operation_also_main_module/models/system_component.dart';\r\n import '../../../repositories/base_repository.dart';\r\n import '../../../services/auth_service.dart';\r\n import '../../../utils/data_point_cache.dart';\r\n"
                }
            ],
            "date": 1734043322906,
            "name": "Commit-0",
            "content": "// lib/blocs/component/repository/component_repository.dart\r\n\r\nimport '../../../modules/system_operation_also_main_module/models/system_component.dart';\r\nimport '../../../services/auth_service.dart';\r\nimport '../../../repositories/system_state_repository.dart';\r\n\r\nclass ComponentRepository {\r\n  final SystemStateRepository _systemStateRepository;\r\n  final AuthService _authService;\r\n\r\n  ComponentRepository(this._systemStateRepository, this._authService);\r\n\r\n  Future<SystemComponent?> getComponent(String componentName) async {\r\n    final userId = _authService.currentUser?.uid;\r\n    if (userId == null) {\r\n      throw Exception('User not authenticated');\r\n    }\r\n    return await _systemStateRepository.getComponentByName(userId, componentName);\r\n  }\r\n\r\n  Future<void> saveComponent(SystemComponent component) async {\r\n    final userId = _authService.currentUser?.uid;\r\n    if (userId == null) {\r\n      throw Exception('User not authenticated');\r\n    }\r\n    await _systemStateRepository.saveComponent(userId, component);\r\n  }\r\n\r\n  Future<void> saveComponentState(SystemComponent component) async {\r\n    final userId = _authService.currentUser?.uid;\r\n    if (userId == null) {\r\n      throw Exception('User not authenticated');\r\n    }\r\n    await _systemStateRepository.saveComponentState(userId, component);\r\n  }\r\n\r\n  Future<List<Map<String, dynamic>>> getComponentHistory(\r\n    String componentName,\r\n    DateTime start,\r\n    DateTime end,\r\n  ) async {\r\n    final userId = _authService.currentUser?.uid;\r\n    if (userId == null) {\r\n      throw Exception('User not authenticated');\r\n    }\r\n    return await _systemStateRepository.getComponentHistory(\r\n      userId,\r\n      componentName,\r\n      start,\r\n      end,\r\n    );\r\n  }\r\n\r\n  Stream<SystemComponent?> watchComponent(String componentName) async* {\r\n    final userId = _authService.currentUser?.uid;\r\n    if (userId == null) {\r\n      throw Exception('User not authenticated');\r\n    }\r\n\r\n    // This is where you'd implement real-time watching using Firestore\r\n    // For now, we'll just yield the current state\r\n    yield await getComponent(componentName);\r\n  }\r\n}"
        }
    ]
}