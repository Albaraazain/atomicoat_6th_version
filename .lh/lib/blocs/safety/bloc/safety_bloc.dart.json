{
    "sourceFile": "lib/blocs/safety/bloc/safety_bloc.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1734048752575,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1734048846657,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,9 @@\n // lib/blocs/safety/bloc/safety_bloc.dart\r\n import 'dart:async';\r\n import 'package:bloc/bloc.dart';\r\n+import 'package:experiment_planner/blocs/alarm/bloc/alarm_event.dart';\r\n+import 'package:experiment_planner/modules/system_operation_also_main_module/models/alarm.dart';\r\n import '../../../modules/system_operation_also_main_module/models/safety_error.dart';\r\n import '../../../modules/system_operation_also_main_module/models/system_component.dart';\r\n import '../../../services/auth_service.dart';\r\n import '../../alarm/bloc/alarm_bloc.dart';\r\n"
                },
                {
                    "date": 1734049192062,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,8 @@\n // lib/blocs/safety/bloc/safety_bloc.dart\r\n import 'dart:async';\r\n import 'package:bloc/bloc.dart';\r\n+import 'package:experiment_planner/blocs/alarm/bloc/alarm_bloc.dart';\r\n import 'package:experiment_planner/blocs/alarm/bloc/alarm_event.dart';\r\n import 'package:experiment_planner/modules/system_operation_also_main_module/models/alarm.dart';\r\n import '../../../modules/system_operation_also_main_module/models/safety_error.dart';\r\n import '../../../modules/system_operation_also_main_module/models/system_component.dart';\r\n@@ -79,12 +80,12 @@\n     try {\r\n       await _repository.addSafetyError(event.error);\r\n \r\n       // Add corresponding alarm\r\n-      _alarmBloc.add(AddAlarm(\r\n+      _alarmBloc.add(AlarmEvent.addAlarm(\r\n         message: event.error.description,\r\n-        severity: _mapSeverityToAlarmSeverity(event.error.severity),\r\n-        isSafetyAlert: true,\r\n+        severity: _mapSafetyToAlarmSeverity(event.error.severity),\r\n+        timestamp: DateTime.now(),\r\n       ));\r\n \r\n     } catch (error) {\r\n       emit(state.copyWith(error: BlocUtils.handleError(error)));\r\n@@ -117,13 +118,17 @@\n       emit(state.copyWith(error: BlocUtils.handleError(error)));\r\n     }\r\n   }\r\n \r\n-  AlarmSeverity _mapSeverityToAlarmSeverity(SafetyErrorSeverity severity) {\r\n-    return switch (severity) {\r\n-      SafetyErrorSeverity.warning => AlarmSeverity.warning,\r\n-      SafetyErrorSeverity.critical => AlarmSeverity.critical,\r\n-    };\r\n+  AlarmSeverity _mapSafetyToAlarmSeverity(SafetyErrorSeverity severity) {\r\n+    switch (severity) {\r\n+      case SafetyErrorSeverity.critical:\r\n+        return AlarmSeverity.critical;\r\n+      case SafetyErrorSeverity.warning:\r\n+        return AlarmSeverity.warning;\r\n+      default:\r\n+        return AlarmSeverity.info;\r\n+    }\r\n   }\r\n \r\n   @override\r\n   Future<void> close() {\r\n"
                },
                {
                    "date": 1734049230151,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -79,13 +79,13 @@\n   ) async {\r\n     try {\r\n       await _repository.addSafetyError(event.error);\r\n \r\n-      // Add corresponding alarm\r\n-      _alarmBloc.add(AlarmEvent.addAlarm(\r\n+      // Add corresponding alarm using constructor\r\n+      _alarmBloc.add(AddAlarm(\r\n         message: event.error.description,\r\n         severity: _mapSafetyToAlarmSeverity(event.error.severity),\r\n-        timestamp: DateTime.now(),\r\n+        isSafetyAlert: true,\r\n       ));\r\n \r\n     } catch (error) {\r\n       emit(state.copyWith(error: BlocUtils.handleError(error)));\r\n"
                },
                {
                    "date": 1734049259316,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,8 @@\n import 'package:experiment_planner/modules/system_operation_also_main_module/models/alarm.dart';\r\n import '../../../modules/system_operation_also_main_module/models/safety_error.dart';\r\n import '../../../modules/system_operation_also_main_module/models/system_component.dart';\r\n import '../../../services/auth_service.dart';\r\n-import '../../alarm/bloc/alarm_bloc.dart';\r\n import '../../utils/bloc_utils.dart';\r\n import '../repository/safety_repository.dart';\r\n import 'safety_event.dart';\r\n import 'safety_state.dart';\r\n"
                }
            ],
            "date": 1734048752575,
            "name": "Commit-0",
            "content": "// lib/blocs/safety/bloc/safety_bloc.dart\r\nimport 'dart:async';\r\nimport 'package:bloc/bloc.dart';\r\nimport '../../../modules/system_operation_also_main_module/models/safety_error.dart';\r\nimport '../../../modules/system_operation_also_main_module/models/system_component.dart';\r\nimport '../../../services/auth_service.dart';\r\nimport '../../alarm/bloc/alarm_bloc.dart';\r\nimport '../../utils/bloc_utils.dart';\r\nimport '../repository/safety_repository.dart';\r\nimport 'safety_event.dart';\r\nimport 'safety_state.dart';\r\n\r\nclass SafetyBloc extends Bloc<SafetyEvent, SafetyState> {\r\n  final SafetyRepository _repository;\r\n  final AuthService _authService;\r\n  final AlarmBloc _alarmBloc;\r\n  StreamSubscription? _errorSubscription;\r\n\r\n  SafetyBloc({\r\n    required SafetyRepository repository,\r\n    required AuthService authService,\r\n    required AlarmBloc alarmBloc,\r\n  })  : _repository = repository,\r\n        _authService = authService,\r\n        _alarmBloc = alarmBloc,\r\n        super(SafetyState.initial()) {\r\n    on<SafetyMonitoringStarted>(_onMonitoringStarted);\r\n    on<SafetyMonitoringPaused>(_onMonitoringPaused);\r\n    on<SafetyErrorDetected>(_onErrorDetected);\r\n    on<SafetyErrorCleared>(_onErrorCleared);\r\n    on<SafetyThresholdAdjusted>(_onThresholdAdjusted);\r\n  }\r\n\r\n  Future<void> _onMonitoringStarted(\r\n    SafetyMonitoringStarted event,\r\n    Emitter<SafetyState> emit,\r\n  ) async {\r\n    try {\r\n      await _errorSubscription?.cancel();\r\n\r\n      _errorSubscription = _repository.watchActiveErrors().listen(\r\n        (errors) {\r\n          emit(state.copyWith(\r\n            isLoading: false,\r\n            isMonitoringActive: true,\r\n            activeErrors: errors,\r\n          ));\r\n        },\r\n        onError: (error) {\r\n          emit(state.copyWith(\r\n            isLoading: false,\r\n            error: BlocUtils.handleError(error),\r\n          ));\r\n        },\r\n      );\r\n    } catch (error) {\r\n      emit(state.copyWith(\r\n        isLoading: false,\r\n        error: BlocUtils.handleError(error),\r\n      ));\r\n    }\r\n  }\r\n\r\n  Future<void> _onMonitoringPaused(\r\n    SafetyMonitoringPaused event,\r\n    Emitter<SafetyState> emit,\r\n  ) async {\r\n    await _errorSubscription?.cancel();\r\n    _errorSubscription = null;\r\n    emit(state.copyWith(isMonitoringActive: false));\r\n  }\r\n\r\n  Future<void> _onErrorDetected(\r\n    SafetyErrorDetected event,\r\n    Emitter<SafetyState> emit,\r\n  ) async {\r\n    try {\r\n      await _repository.addSafetyError(event.error);\r\n\r\n      // Add corresponding alarm\r\n      _alarmBloc.add(AddAlarm(\r\n        message: event.error.description,\r\n        severity: _mapSeverityToAlarmSeverity(event.error.severity),\r\n        isSafetyAlert: true,\r\n      ));\r\n\r\n    } catch (error) {\r\n      emit(state.copyWith(error: BlocUtils.handleError(error)));\r\n    }\r\n  }\r\n\r\n  Future<void> _onErrorCleared(\r\n    SafetyErrorCleared event,\r\n    Emitter<SafetyState> emit,\r\n  ) async {\r\n    try {\r\n      await _repository.resolveError(event.errorId);\r\n    } catch (error) {\r\n      emit(state.copyWith(error: BlocUtils.handleError(error)));\r\n    }\r\n  }\r\n\r\n  Future<void> _onThresholdAdjusted(\r\n    SafetyThresholdAdjusted event,\r\n    Emitter<SafetyState> emit,\r\n  ) async {\r\n    try {\r\n      await _repository.updateThresholds(\r\n        event.componentId,\r\n        event.parameterName,\r\n        event.minThreshold,\r\n        event.maxThreshold,\r\n      );\r\n    } catch (error) {\r\n      emit(state.copyWith(error: BlocUtils.handleError(error)));\r\n    }\r\n  }\r\n\r\n  AlarmSeverity _mapSeverityToAlarmSeverity(SafetyErrorSeverity severity) {\r\n    return switch (severity) {\r\n      SafetyErrorSeverity.warning => AlarmSeverity.warning,\r\n      SafetyErrorSeverity.critical => AlarmSeverity.critical,\r\n    };\r\n  }\r\n\r\n  @override\r\n  Future<void> close() {\r\n    _errorSubscription?.cancel();\r\n    return super.close();\r\n  }\r\n}"
        }
    ]
}